["```js\ninterface AST {\n emit(): void;\n equals(other: AST): boolean;\n}\n```", "```js\nemit(\"  add r1, r2, r3\");\n```", "```js\nlet x = 42;\nemit(`  add r1, r2, #${x}`);\n```", "```js\nlet emit = console.log;\n```", "```js\nclass Number implements AST {\n constructor(public value: number) {}\n\n emit() { throw Error(\"Not implemented yet\"); }\n\n equals(other: AST) {…}\n}\n```", "```js\nemit() {\n emit(`  ldr r0, =${this.value}`);\n}\n```", "```js\nclass Main implements AST {\n constructor(public statements: Array<AST>) {}\n\n emit() { /* TODO */ }\n\n equals(other: AST) {…}\n}\n```", "```js\nclass Assert implements AST {\n constructor(public condition: AST) {}\n\n emit() { /* TODO */ }\n\n equals(other: AST) {…}\n}\n```", "```js\n// functionStatement <-\n//   FUNCTION ID LEFT_PAREN parameters RIGHT_PAREN\n//   blockStatement\nlet functionStatement: Parser<AST> =\n FUNCTION.and(ID).bind((name) =>\n LEFT_PAREN.and(parameters).bind((parameters) =>\n RIGHT_PAREN.and(blockStatement).bind((block) =>\n constant(\n name === 'main'\n ? new Main(block.statements)\n : new Function(name, parameters, block)))));\n```", "```js\n// call <- ID LEFT_PAREN args RIGHT_PAREN\nlet call: Parser<AST> =\n ID.bind((callee) =>\n LEFT_PAREN.and(args.bind((args) =>\n RIGHT_PAREN.and(constant(\n callee === 'assert'\n ? new Assert(args[0])\n : new Call(callee, args))))));\n```", "```js\n.global main\nmain:\n push {fp, lr}\n …\n mov r0, #0\n pop {fp, pc}\n```", "```js\nclass Main implements AST {\n constructor(public statements: Array<AST>) {}\n\n emit() {\n emit(`.global main`);\n emit(`main:`);\n emit(`  push {fp, lr}`);\n this.statements.forEach((statement) =>\n statement.emit()\n );\n emit(`  mov r0, #0`);\n emit(`  pop {fp, pc}`);\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nnew Main([]).emit();\n```", "```js\nparser.parseStringToCompletion(`\n function main() {\n\n }\n`).emit();\n```", "```js\n cmp r0, #1\n moveq r0, #'.'\n movne r0, #'F'\n bl putchar\n```", "```js\nclass Assert implements AST {\n constructor(public condition: AST) {}\n\n emit() {\n this.condition.emit();\n emit(`  cmp r0, #1`);\n emit(`  moveq r0, #'.'`);\n emit(`  movne r0, #'F'`);\n emit(`  bl putchar`);\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nclass Number implements AST {\n constructor(public value: number) {}\n\n emit() {\n emit(`  ldr r0, =${this.value}`);\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nparser.parseStringToCompletion(`\n function main() {\n assert(1);\n }\n`).emit();\n```", "```js\nclass Not implements AST {\n constructor(public term: AST) {}\n\n emit() {\n this.term.emit();\n emit(`  cmp r0, #0`);\n emit(`  moveq r0, #1`);\n emit(`  movne r0, #0`);\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nfunction main() {\n assert(1);\n assert(!0);\n}\n```", "```js\nclass Add implements AST {\n constructor(public left: AST, public right: AST) {}\n\n emit() { /* First flawed attempt */\n this.left.emit();\n emit(`mov r1, r0`);\n this.right.emit();\n emit(`add r0, r1, r0`);\n }\n\n equals(other: AST) {…}\n}\n```", "```js\n emit() { /* Second attempt */\n this.left.emit();\n emit(`push {r0, ip}`);\n this.right.emit();\n emit(`pop {r1, ip}`);\n emit(`add r0, r1, r0`);\n }\n```", "```js\nadd r0, r1, r0\n```", "```js\nsub r0, r1, r0\n```", "```js\nmul r0, r1, r0\n```", "```js\nudiv r0, r1, r0\n```", "```js\ncmp r0, r1\nmoveq r0, #1\nmovne r0, #0\n```", "```js\ncmp r0, r1\nmoveq r0, #0\nmovne r0, #1\n```", "```js\nfunction main() {\n assert(1);\n assert(!0);\n assert(42 == 4 + 2 * (12 - 2) + 3 * (5 + 1));\n}\n```", "```js\nclass Block implements AST {\n constructor(public statements: Array<AST>) {}\n\n emit() {\n this.statements.forEach((statement) =>\n statement.emit()\n );\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nfunction main() {\n assert(1);\n assert(!0);\n assert(42 == 4 + 2 * (12 - 2) + 3 * (5 + 1));\n { /* Testing a block statement */\n assert(1);\n assert(1);\n }\n}\n```", "```js\nclass Call implements AST {\n constructor(public callee: string,\n public args: Array<AST>) {}\n\n emit() {\n …\n }\n\n …\n}\n```", "```js\n // One argument\n emit(`  bl ${this.callee}`);\n```", "```js\n // Two arguments\n this.args[0].emit();\n emit(`  bl ${this.callee}`);\n```", "```js\n // Up to four arguments\n emit(`  sub sp, sp, #16`);\n this.args.forEach((arg, i) => {\n arg.emit();\n emit(`  str r0, [sp, #${4 * i}]`);\n });\n emit(`  pop {r0, r1, r2, r3}`);\n emit(`  bl ${this.callee}`);\n```", "```js\nclass Call implements AST {\n constructor(public callee: string,\n public args: Array<AST>) {}\n emit() {\n let count = this.args.length;\n if (count === 0) {\n emit(`  bl ${this.callee}`);\n } else if (count === 1) {\n this.args[0].emit();\n emit(`  bl ${this.callee}`);\n } else if (count >= 2 && count <= 4) {\n emit(`  sub sp, sp, #16`);\n this.args.forEach((arg, i) => {\n arg.emit();\n emit(`  str r0, [sp, #${4 * i}]`);\n });\n emit(`  pop {r0, r1, r2, r3}`);\n emit(`  bl ${this.callee}`);\n } else {\n throw Error(\"More than 4 arguments: not supported\");\n }\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nputchar(46);\nassert(rand() != 42);\n```", "```js\nif (rand()) {   /* Conditional */\n putchar(46);  /* Consequence */\n} else {\n putchar(70);  /* Alternative */\n}\n```", "```js\n bl rand\n cmp r0, #0\n beq ifFalse\n bne ifTrue\n\nifTrue:\n ldr r0, =46\n bl putchar\n b endIf\n\nifFalse:\n ldr r0, =70\n bl putchar\n b endIf\n\nendIf:\n /* Whatever follows next */\n```", "```js\n bl rand\n cmp r0, #0\n beq ifFalse\n\n ldr r0, =46\n bl putchar\n b endIf\n\nifFalse:\n ldr r0, =70\n bl putchar\n\nendIf:\n /* Whatever follows next */\n```", "```js\nclass Label {\n static counter = 0;\n value: number;\n\n constructor() {\n this.value = Label.counter++;\n }\n\n toString() {\n return `.L${this.value}`;\n }\n}\n```", "```js\nclass If implements AST {\n constructor(public conditional: AST,\n public consequence: AST,\n public alternative: AST) {}\n\n emit() {\n let ifFalseLabel = new Label();\n let endIfLabel = new Label();\n this.conditional.emit();\n emit(`  cmp r0, #0`);\n emit(`  beq ${ifFalseLabel}`);\n this.consequence.emit();\n emit(`  b ${endIfLabel}`);\n emit(`${ifFalseLabel}:`);\n this.alternative.emit();\n emit(`${endIfLabel}:`);\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nif (1) {\n assert(1);\n} else {\n assert(0);\n}\n\nif (0) {\n assert(0);\n} else {\n assert(1);\n}\n```", "```js\nclass Function implements AST {\n constructor(public name: string,\n public parameters: Array<string>,\n public body: AST) {}\n\n /* First attempt */\n emit() {\n if (this.parameters.length > 4)\n throw Error(\"More than 4 parameters: not supported\");\n\n emit(``);\n emit(`.global ${this.name}`);\n emit(`${this.name}:`);\n this.emitPrologue();\n this.body.emit();\n this.emitEpilogue();\n }\n\n emitPrologue() {\n emit(`  push {fp, lr}`);\n emit(`  mov fp, sp`);\n emit(`  push {r0, r1, r2, r3}`);\n }\n\n emitEpilogue() {\n emit(`  mov sp, fp`);\n emit(`  mov r0, #0`);\n emit(`  pop {fp, pc}`);\n }\n\n equals() {…}\n}\n```", "```js\n push {r3}\n push {r2}\n push {r1}\n push {r0}\n```", "```js\n ldr r0, [fp, #-16]\n```", "```js\nclass Environment {\n /* Initial version */\n constructor(public locals: Map<string, number>) {}\n}\n```", "```js\ninterface AST {\n emit(env: Environment): void;\n equals(other: AST): boolean;\n}\n```", "```js\nclass Add implements AST {\n constructor(public left: AST,\n public right: AST) {}\n\n emit(env: Environment) {\n this.left.emit(env);\n emit(`  push {r0, ip}`);\n this.right.emit(env);\n emit(`  pop {r1, ip}`);\n emit(`  add r0, r1, r0`);\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nclass Function implements AST {\n …\n\n /* Second attempt */\n emit(_: Environment) {\n if (this.parameters.length > 4)\n throw Error(\"More than 4 parameters: not supported\");\n\n emit(``);\n emit(`.global ${this.name}`);\n emit(`${this.name}:`);\n this.emitPrologue();\n let env = this.setUpEnvironment();\n this.body.emit(env);\n this.emitEpilogue();\n }\n```", "```js\n setUpEnvironment() {\n let locals = new Map();\n this.parameters.forEach((parameter, i) => {\n locals.set(parameter, 4 * i - 16);\n });\n return new Environment(locals);\n }\n}\n```", "```js\nclass Id implements AST {\n constructor(public value: string) {}\n\n emit(env: Environment) {\n let offset = env.locals.get(this.value);\n if (offset) {\n emit(`  ldr r0, [fp, #${offset}]`);\n } else {\n throw Error(`Undefined variable: ${this.value}`);\n }\n }\n\n equals() {…}\n}\n```", "```js\nfunction assert(x) {\n if (x) {\n putchar(46);\n } else {\n putchar(70);\n }\n}\n```", "```js\nfunction assert1234(a, b, c, d) {\n assert(a == 1);\n assert(b == 2);\n assert(c == 3);\n assert(d == 4);\n}\n```", "```js\nclass Return implements AST {\n constructor(public term: AST) {}\n\n emit(env) {\n this.term.emit(env);\n emit(`  mov sp, fp`);\n emit(`  pop {fp, pc}`);\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nfunction factorial(n) {\n if (n == 0) {\n return 1;\n } else {\n return n * factorial(n - 1);\n }\n}\n```", "```js\nassert(factorial(5) == 120);\n```", "```js\nfunction f() {\n let x = 1;\n {\n let x = 2;\n }\n console.log(x);\n}\n```", "```js\nfunction f() {\n var x = 1;\n {\n var x = 2;\n }\n console.log(x);\n}\n```", "```js\nclass Environment {\n constructor(public locals: Map<string, number>,\n public nextLocalOffset: number) {}\n}\n```", "```js\nclass Function implements AST {\n …\n setUpEnvironment() {\n let locals = new Map();\n this.parameters.forEach((parameter, i) => {\n locals.set(parameter, 4 * i - 16);\n });\n nextLocalOffset = -20;\n return new Environment(locals, nextLocalOffset);\n }\n …\n}\n```", "```js\nclass Var implements AST {\n constructor(public name: string,\n public value: AST) {}\n\n emit(env: Environment) {\n this.value.emit(env);\n emit(`  push {r0, ip}`);\n env.locals.set(this.name, env.nextLocalOffset - 4);\n env.nextLocalOffset -= 8;\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nvar x = 4 + 2 * (12 - 2);\nvar y = 3 * (5 + 1);\nvar z = x + y;\nassert(z == 42);\n```", "```js\nclass Assign implements AST {\n constructor(public name: string,\n public value: AST) {}\n\n emit(env: Environment) {\n this.value.emit(env);\n let offset = env.locals.get(this.name);\n if (offset) {\n emit(`  str r0, [fp, #${offset}]`);\n } else {\n throw Error(`Undefined variable: ${this.name}`);\n }\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nvar a = 1;\nassert(a == 1);\na = 0;\nassert(a == 0);\n```", "```js\nclass While implements AST {\n constructor(public conditional: AST,\n public body: AST) {}\n\n emit(env: Environment) {\n let loopStart = new Label();\n let loopEnd = new Label();\n\n emit(`${loopStart}:`);\n this.conditional.emit(env);\n emit(`  cmp r0, #0`);\n emit(`  beq ${loopEnd}`);\n this.body.emit(env);\n emit(`  b ${loopStart}`);\n emit(`${loopEnd}:`);\n }\n\n equals(other: AST) {…}\n}\n```", "```js\nvar i = 0;\nwhile (i != 3) {\n i = i + 1;\n}\nassert(i == 3);\n```", "```js\nfunction factorial(n) {\n var result = 1;\n while (n != 1) {\n result = result * n;\n n = n - 1;\n }\n return result;\n}\n```", "```js\n> for (i = 1; i < 5; i = i + 1) {\n>  body();\n> }\n> ```", "```js\n> i = 1;\n> while (i < 5) {\n>  i = i + 1;\n>  body();\n> }\n> ```"]